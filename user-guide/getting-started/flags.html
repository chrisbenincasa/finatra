<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Flags &mdash; Finatra User&#39;s Guide 2.8.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.8.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Finatra User&#39;s Guide 2.8.0 documentation" href="../index.html" />
    <link rel="next" title="Future Gotchas" href="futures.html" />
    <link rel="prev" title="Binding Annotations" href="binding_annotations.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head>
  <body role="document">
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="futures.html" title="Future Gotchas"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="binding_annotations.html" title="Binding Annotations"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Finatra</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="flags">
<span id="id1"></span><h1>Flags<a class="headerlink" href="#flags" title="Permalink to this headline">¶</a></h1>
<p>Finatra builds on the support of <a class="reference external" href="https://github.com/twitter/util">TwitterUtil</a> <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/Flag.scala">Flags</a> from <a class="reference external" href="https://twitter.github.io/twitter-server/Features.html#flags">TwitterServer</a>, adding the ability to inject flag values into your classes.</p>
<p>Flags by their definition represent some external configuration that is passed to the server and are thus an excellent way to parameterize configuration that may be environment specific, e.g., a database host or URL that is different per environment: <em>production</em>, <em>staging</em>, <em>development</em>, or <em>jills-staging</em>. This allows you to work with the same application code in different environments.</p>
<p>This type of configuration parameterization is generally preferred over hardcoding logic by a type of &#8220;<em>environment</em>&#8221; string within code, e.g.</p>
<div class="code bash highlight-text"><div class="highlight"><pre><span></span>if (env == &quot;production&quot;) { ... }
</pre></div>
</div>
<p>It is generally good practice to make flags <em>granular</em> controls that are  fully orthogonal to one another. They can then be independently managed for each deploy and this scales consistently as the number of supported  &#8220;environments&#8221; scales.</p>
<div class="section" id="but-i-have-a-lot-of-flags">
<h2>But I have a lot of Flags<a class="headerlink" href="#but-i-have-a-lot-of-flags" title="Permalink to this headline">¶</a></h2>
<p>If you find that you end up with a lot of flags to configure for your service and your deployment system provides no relief &#8211; there are still alternatives to moving external configuration into code.</p>
<p>See <a class="reference external" href="https://groups.google.com/forum/#!searchin/finatra-users/typesafe$20config%7Csort:relevance/finatra-users/kkZgI5dG9CY/lzDPAmUxAwAJ">this thread</a> on using <a class="reference external" href="https://github.com/typesafehub/config">Typesafe Config</a> with Finatra and this <a class="reference external" href="https://github.com/dkowis/finatra-typesafe-config">example repository</a>.</p>
</div>
<div class="section" id="how-to-define-flags">
<h2>How To Define Flags<a class="headerlink" href="#how-to-define-flags" title="Permalink to this headline">¶</a></h2>
<p>Flags can be <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http/src/test/scala/com/twitter/finatra/http/tests/integration/doeverything/main/modules/DoEverythingModule.scala#L13">defined</a> within a <a class="reference external" href="modules.html">Module</a> to allow for scoping of reusable external configuration (since Modules are meant to be re-usable). Though, you can also choose to define a flag <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http/src/test/scala/com/twitter/finatra/http/tests/integration/doeverything/main/DoEverythingServer.scala#L22">directly in a server</a>.</p>
<p>When defined within a <a class="reference external" href="modules.html">Module</a>, flags can be used to aid in the construction of an instance to be <a class="reference external" href="modules.html#provides">provided to the object graph</a>, e.g., a DatabaseConnection instance with the database URL specified by a flag. The module is then able to tell the injector how to provide an instance of this type when necessary by defining an <code class="docutils literal"><span class="pre">&#64;Provides</span></code> annotated method.</p>
<p>In Finatra, we also provide a way to override bound instances in the object graph when testing through <a class="reference external" href="../testing/index.html#override-modules">Override Modules</a> or with <a class="reference external" href="../testing/index.html#bind">&#64;Bind</a>.</p>
</div>
<div class="section" id="flag-annotation">
<h2><code class="docutils literal"><span class="pre">&#64;Flag</span></code> annotation<a class="headerlink" href="#flag-annotation" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">&#64;Flag</span></code> is a <a class="reference external" href="../getting-started/binding_annotations.html">binding annotation</a>. This annotation allows flag values to be injected into classes (and provider methods).</p>
<div class="section" id="flag-definition">
<h3>Flag Definition<a class="headerlink" href="#flag-definition" title="Permalink to this headline">¶</a></h3>
<p>Define a flag (in this case within a <cite>TwitterModule</cite>)</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class MyModule extends TwitterModule {
  flag(name = &quot;key&quot;, default = &quot;default&quot;, help = &quot;The key to use&quot;)

  @Provides
  @Singleton
  def providesFoo(
    @Flag(&quot;key&quot;) key: String) = {
    new Foo(key)
  }
}
</pre></div>
</div>
<p>In the example above, notice that we do not save a local reference to the created <cite>Flag</cite> and instead reference it&#8217;s value in the provider method by use of the <code class="docutils literal"><span class="pre">&#64;Flag</span></code> binding annotation.</p>
<p>However, when defining a flag you can also simply dereference the flag directly within the module or server (in lieu of using the <code class="docutils literal"><span class="pre">&#64;Flag</span></code> annotation). Just keep a local reference
to the created, then you can use the <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/Flag.scala#L171">Flag#apply</a>, <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/Flag.scala#L205">Flag#get</a> or other methods, depending e.g.:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>object MyModule1 extends TwitterModule {
  val key = flag(name = &quot;key&quot;, default = &quot;default&quot;, help = &quot;The key to use&quot;)

  @Singleton
  @Provides
  def providesThirdPartyFoo: ThirdPartyFoo = {
    new ThirdPartyFoo(key())
  }
}
</pre></div>
</div>
</div>
<div class="section" id="flag-value-injection">
<h3>Flag Value Injection<a class="headerlink" href="#flag-value-injection" title="Permalink to this headline">¶</a></h3>
<p>Flags specified with defaults can be injected as a constructor-arg to a class. When the class is obtained from the injector the correctly parsed flag value will be injected.</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class MyService @Inject()(
  @Flag(&quot;key&quot;) key: String) {
}
</pre></div>
</div>
<p>Note, you can also always instantiate the above class manually. When doing so, you will need to pass all the constructor args manually including a value for the flag argument.</p>
</div>
</div>
<div class="section" id="flags-without-defaults">
<h2>Flags Without Defaults<a class="headerlink" href="#flags-without-defaults" title="Permalink to this headline">¶</a></h2>
<p><cite>TwitterModule#flag</cite> is parameterized to return a Flag of type <cite>T</cite> where <cite>T</cite> is the type of the argument passed as the default. If you do not specify a default value then you must explicitly parameterize your call to <cite>TwitterModule#flag</cite> with a defined type <cite>T</cite>, e.g,</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>object MyModule1 extends TwitterModule {
  val key = flag[String](name = &quot;key&quot;, help = &quot;The key to use&quot;)

  @Singleton
  @Provides
  def providesThirdPartyFoo: ThirdPartyFoo = {
    val myKey = key.get match {
      case Some(value) =&gt; value
      case _ =&gt; &quot;DEFAULT&quot;
    }
    new ThirdPartyFoo(myKey)
  }
}
</pre></div>
</div>
<p>Keep in mind that the specified <cite>T</cite> in this case must be a <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/Flaggable.scala">Flaggable</a> type.</p>
<p>Note that you should not call <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/Flag.scala#L171">Flag#apply</a> on a <cite>Flag</cite> without a default (as this will result in an Exception) but instead use <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/Flag.scala#L205">Flag#get</a> which returns an <cite>Option[T]</cite>.</p>
<p>Because Finatra does not currently support binding optional types, Flags without defaults <em>are not injectable</em> but can still be useful for accepting external configuration for either <a class="reference external" href="modules.html#using-flags-in-modules">providing instances to the object graph</a> or for a server.</p>
<p>This means if you try to inject a non-defaulted <cite>Flag</cite> instance using the <code class="docutils literal"><span class="pre">&#64;Flag</span></code> binding annotation <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/internal/FlagsModule.scala#L34">you will get an IllegalArgumentException</a>.</p>
</div>
<div class="section" id="passing-flag-values-as-command-line-arguments">
<h2>Passing Flag Values as Command-Line Arguments<a class="headerlink" href="#passing-flag-values-as-command-line-arguments" title="Permalink to this headline">¶</a></h2>
<p>Flags are set by passing them as arguments to your java application. E.g.,</p>
<div class="code bash highlight-text"><div class="highlight"><pre><span></span>$ java -jar finatra-hello-world-assembly-2.0.0.jar -key=value
</pre></div>
</div>
<p>An example of this is passing the <cite>-help</cite> flag to see usage for running a Finatra server, e.g.</p>
<div class="code bash highlight-text"><div class="highlight"><pre><span></span>$ java -jar finatra-hello-world-assembly-2.0.0.jar -help
HelloWorldServer
  -alarm_durations=&#39;1.seconds,5.seconds&#39;: 2 alarm durations
  -help=&#39;false&#39;: Show this help
  -admin.port=&#39;:8080&#39;: Admin http server port
  -bind=&#39;:0&#39;: Network interface to use
  -log.level=&#39;INFO&#39;: Log level
  -log.output=&#39;/dev/stderr&#39;: Output file
  -key=&#39;default&#39;: The key to use
</pre></div>
</div>
</div>
<div class="section" id="failfastonflagsnotparsed">
<h2><code class="docutils literal"><span class="pre">failfastOnFlagsNotParsed</span></code><a class="headerlink" href="#failfastonflagsnotparsed" title="Permalink to this headline">¶</a></h2>
<p>Note that Finatra defaults the <cite>failfastOnFlagsNotParsed</cite> option as mentioned in the <a class="reference external" href="https://twitter.github.io/twitter-server/Features.html#flags">TwitterServer documentation</a> to <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/main/scala/com/twitter/inject/server/TwitterServer.scala#L61">true</a> for you.</p>
</div>
<div class="section" id="modules-depending-on-other-modules">
<h2>Modules Depending on Other Modules<a class="headerlink" href="#modules-depending-on-other-modules" title="Permalink to this headline">¶</a></h2>
<p>There may be times where you would like to reuse the flags defined in a given module inside another module. For instance, we have a module which defines a configuration flag that is useful in other contexts.</p>
<p>As an example, let&#8217;s assume we have a module which defines a flag for the service&#8217;s <cite>ClientId</cite> String &#8211; how it identifies itself as client to other services &#8211; that is necessary for constructing different clients:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>object ClientIdModule extends TwitterModule {
  flag[String](&quot;client.id&quot;, &quot;System-wide client id for identifying this server as a client to other services.&quot;)
}
</pre></div>
</div>
<p>You could choose to build and provide every client which needs this <cite>ClientId</cite> in the same module or you could decide to break up the client creation into separate modules (allowing them to be used and tested independently). If you do the latter, how do you get access to the set <cite>ClientId</cite> value from the <cite>ClientIdModule</cite> inside of another Module?</p>
<p>Typically, you would inject the flag value using the <code class="docutils literal"><span class="pre">&#64;Flag</span></code> <a class="reference external" href="binding_annotations.html">binding annotation</a> as a class constructor-arg. You can do the same for usage from a module &#8211; however instead of the injection point being the constructor annotated with <code class="docutils literal"><span class="pre">&#64;Inject</span></code>, it is the argument list of any <code class="docutils literal"><span class="pre">&#64;Provides</span></code>-annotated method.</p>
<p>E.g.,</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>object ClientAModule extends TwitterModule {
  override val modules = Seq(ClientIdModule)

  @Singleton
  @Provides
  def provideClientA(
    @Flag(&quot;client.id&quot;) clientId): ClientA = {
    new ClientA(clientId)
  }
}
</pre></div>
</div>
<p>What&#8217;s happening here?</p>
<p>Firstly, we define a <cite>ClientAModule</cite> and override the <cite>modules</cite> val to be a <cite>Seq</cite> of modules that includes the <cite>ClientIdModule</cite>. This guarantees that if the <cite>ClientIdModule</cite> is not mixed into the list of modules for a server, the <cite>ClientAModule</cite> ensures it will be installed since it&#8217;s declared as a dependency.</p>
<p>This ensures that there will be a bound value for the <cite>ClientId</cite> flag. Otherwise, our module definition is brittle in that we are trying to make use of a flag which may never be defined within the scope of our server. With TwitterUtil flags, trying to use an undefined flag <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/Flags.scala#L118">could cause your server to fail to start</a>.</p>
<p>Thus we want to ensure that if we are only using flags we define in our module or we include the module that does. Note that it is an <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/Flags.scala#L251">error to try to define the same flag twice</a>.</p>
<p>Finatra will de-dupe all modules before installing, so it&#8217;s OK if a module appears twice in the server configuration, though you should strive to make this the exception.</p>
<p>Secondly, we then define a method which provides a <cite>ClientA</cite>. Since injection is by type (and the argument list to an <code class="docutils literal"><span class="pre">&#64;Provides</span></code> annotated method in a module is an injection point) and <code class="docutils literal"><span class="pre">String</span></code> is not specific enough we use the <code class="docutils literal"><span class="pre">&#64;Flag</span></code> <a class="reference external" href="binding_annotations.html">binding annotation</a>.</p>
<p>We could continue this through another module. For example, if we wanted to provide a <cite>ClientB</cite> which needs both the <cite>ClientId</cite> and a <cite>ClientA</cite> we could define a <cite>ClientBModule</cite>:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>object ClientBModule extends TwitterModule {
  override val modules = Seq(
    ClientIdModule,
    ClientAModule)

  @Singleton
  @Provides
  def provideClientB(
    @Flag(&quot;client.id&quot;) clientId,
    clientA: ClientA): ClientB = {
    new ClientB(clientId, clientA)
  }
}
</pre></div>
</div>
<p>Notice that we choose to list both the <cite>ClientIdModule</cite> and <cite>ClientAModule</cite> in the modules for the <cite>ClientBModule</cite>. Yet, since we know that the <cite>ClientAModule</cite> includes the <cite>ClientIdModule</cite> we could have choosen to leave it out. The &#8220;provides&#8221; method in the module above takes in both a <cite>ClientId</cite> String and a <cite>ClientA</cite>.</p>
<p>Since it declares the two modules we&#8217;re assured that these types will be available from the injector for our &#8220;provides&#8221; method to use.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  Finatra is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/">Site&nbsp;&amp;&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Github&nbsp;Repository</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Issues</a></li>
</ul>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Flags</a><ul>
<li><a class="reference internal" href="#but-i-have-a-lot-of-flags">But I have a lot of Flags</a></li>
<li><a class="reference internal" href="#how-to-define-flags">How To Define Flags</a></li>
<li><a class="reference internal" href="#flag-annotation"><code class="docutils literal"><span class="pre">&#64;Flag</span></code> annotation</a><ul>
<li><a class="reference internal" href="#flag-definition">Flag Definition</a></li>
<li><a class="reference internal" href="#flag-value-injection">Flag Value Injection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#flags-without-defaults">Flags Without Defaults</a></li>
<li><a class="reference internal" href="#passing-flag-values-as-command-line-arguments">Passing Flag Values as Command-Line Arguments</a></li>
<li><a class="reference internal" href="#failfastonflagsnotparsed"><code class="docutils literal"><span class="pre">failfastOnFlagsNotParsed</span></code></a></li>
<li><a class="reference internal" href="#modules-depending-on-other-modules">Modules Depending on Other Modules</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="binding_annotations.html" title="previous chapter">Binding Annotations</a></li>
      <li>Next: <a href="futures.html" title="next chapter">Future Gotchas</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2013-2017 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>